# 小程序分享朋友圈
小程序可以分享到朋友圈这个新能力一出来，瞬间就刷爆了每一个小程序开发者的朋友圈。每个人都希望在自己的小程序中引入分享到朋友圈功能，如果你也对此感兴趣，不妨和我一起动手来做，让云开发开发的小程序也可以支持小程序的分享到朋友圈功能。

## 小程序分享朋友圈到底是个什么功能？

小程序分享朋友圈功能，严格来说，应该是对小程序的“单页模式”的支持。如果你的小程序支持了单页模式，你的小程序就可以支持分享到朋友圈，让朋友圈的人查看相关的内容。

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-090352.png)

## 让你的小程序支持分享朋友圈，只需要这四步

想要让你的小程序支持分享到朋友圈这个目前还没有完全放量的功能，你需要做以下这四步：

1. **安装开发版 Nightly 微信开发者工具**：方便进行云开发的配置
2. **配置云开发环境的权限**：设置允许未登录用户访问云开发环境
3. **调整云数据库、云函数的权限**：设置允许未登录的用户访问云开发的云数据库权限
4. **配置小程序的 onShareTimeline**: 设置用户在点击分享时，显示分享到朋友圈。

接下来， 我们具体来看一下这四步：



### 第一步：安装开发版 Nightly 微信开发者工具

由于开启未登录这个功能需要进行配置，而目前的稳定版本的微信开发者工具尚不支持相关配置，因此**你需要下载开发版本的微信开发者工具，来对云开发环境进行配置**。

你可以访问微信小程序官方文档，在其中的 「**工具**」— 「**下载**」中找到**开发版 Nightly Build 版本**的下载链接，下载对应版本的开发者工具，并安装到本地。

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-072837.png)

安装完成后，可以**使用开发版本的微信开发者工具打开你的小程序**。

打开后，点击项目的「详情」 — 「本地设置」中修改「调试基础库」，将**你的基础库设置在 2.11.3 及以上的版本**，并推送到手机客户端，从而确保在调试时，不会受到基础库版本的限制。

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-073626.png)

### 第二步：配置云开发环境的权限

在完成了基础库的配置后，就可以配置云开发环境的权限了，点击开发者工具顶部的「云开发」，进入到云开发的控制台界面。

在云开发控制台找到 「**设置**」 —「**全局设置**」中修改 「**未登录用户访问云资源权限设置**」，为你要使用的环境开启「**未登录用户访问云资源的权限**」

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-073847.png)

在配置了相应的权限后，你就可以在让用户未登录的情况下访问云开发资源（不仅仅是小程序，也可以在 Web 网页中使用哦～）

### 第三步：配置云数据库及云函数权限

开通了云环境的未登录访问后，还需要做的一步，就是给你的数据库以及函数配置未登录访问的权限。**默认情况下，使用云开发提供的简易权限配置需要用户登录，如果你想要使用未登录访问云开发资源，则需要将模式调整为自定义安全规则模式**。

#### 配置云数据库的访问权限

打开云开发控制台中的数据库页面，找到我们需要在分享朋友圈时使用的数据库，将其权限设置为「**自定义安全规则**」

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-074509.png)

并根据你的实际需要，调整这里的安全规则（关于安全规则，可以前往[官方文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/security-rules.html#%E7%AE%80%E4%BB%8B)查看详情）

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-074541.png)

比如，截图的规则就设置了**在未登录情况下，用户可以访问数据，但无法修改数据**。根据你的实际业务需求，可以调整这里的规则。

修改好相应的自定义权限后，你就可以进行开发，在分享朋友圈的时候也能读取到云开发数据库中的权限。

#### 配置云函数的权限

在分享朋友圈的页面中，我们除了会使用云数据库以外，也会用到云函数，因此我们也需要配置一下相应的云函数权限。

打开云开发控制台中的云函数页面，切换至「**权限设置**」页面，点击「**自定义安全规则**」后的修改按钮，可以对云函数的调用权限进行设置。

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-074908.png)

默认情况下，其规则是**仅允许有登录态的用户访问**，不符合单页模式的需求，因此，需要将其权限设置为所有用户可访问。

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-075007.png)

将安全规则设置为如下规则，就可以实现让所有用户访问云函数。

```json
{
  "*": {
    "invoke": true
  }
}
```



### 第四步：配置小程序侧的参数，令其支持分享到朋友圈

在完成了云开发的配置后，我们就可以通过简单的配置来完成小程序侧的函数配置。

如果希望在小程序中开启分享朋友圈功能，则需要在相应的页面配置 `onShareTimeline` 函数，从而开启相应的分享功能。

不过需要注意的是，微信小程序的规则限制，必须同时配置分享朋友圈和分享给好友，才能开启分享朋友圈，单独配置 `onShareTimeline` 将会无法生效，需要同时配置 `onShareAppMessage` 和 `onShareTimeline` 才能确保生效。

![](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-%E9%BB%98%E8%AE%A4%E6%A0%87%E9%A2%98_%E8%87%AA%E5%AE%9A%E4%B9%89cm_2020-07-09-0.png)

在具体使用时， 可以在 **page.js** 中配置 `onShareTimeline` 方法，并在方法内返回 title,query 和 imageUrl 参数，就可以实现分享朋友圈的能力。

```javascript
Page({
  onShareAppMessage: function () {

  },
  onShareTimeline(){
    return {
      title:"分享朋友圈标题",
      query:"channel=timeline",
      imageUrl:"分享图片地址（支持云开发 FileID）"
    }
  }
})
```





## 使用分享朋友圈功能，我们需要注意什么？

朋友圈功能在使用时是比较简单的，只需要配置好 `onShareTimeline` 即可，不过，在使用时还有一些小的点需要注意：

1. **分享朋友圈时，只能分享当前页面**：在分享朋友圈时，你只能分享当前业务，用户点击分享在朋友圈的单页时，只会进入到当前页面。
2. **单页模式模式下，用户调用云函数获取不到 openid，因此相应的依赖需要处理**：分享朋友圈的单页模式下，云函数、云数据库均无法获取到 openid，因此，相应涉及到的能力需要做好相应的处理，避免业务出错。

## 总结

简单四步，我们就可以完成使用云开发开发小程序的分享朋友圈操作，你还不来给你自己的小程序加上这个劲爆的功能？

[点击下载源码](https://cloudbasenet-1258016615.cos.ap-guangzhou.myqcloud.com/2020-07-09-shareTimeLine.zip)
